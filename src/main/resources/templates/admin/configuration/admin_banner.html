<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" th:href="@{/images/member/favicon.png}">
    <title>[[${basicData.title}]]-[[${basicData.sub_title}]]::관리자 환경설정 [[${appInfo.appVersion}]]</title>
    <link rel="stylesheet" th:href="@{/css/admin/main/header_footer.css}">
    <link rel="stylesheet" th:href="@{/css/admin/configuration/banner.css}">
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const bannerBox = document.getElementById("banner_box");
            const bannerList = document.getElementById("banner_list");

            /* =====================
               배너 데이터 로딩
            ===================== */
            function loadBanners(location) {
                fetch(`/kmarket/admin/config/banner/list?location=${location}`)
                    .then(res => {
                        const contentType = res.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            throw new Error("서버에서 JSON이 아닌 응답을 반환했습니다.");
                        }
                        return res.json();
                    })
                    .then(data => {
                        bannerList.innerHTML = "";

                        if (!data || data.length === 0) {
                            const emptyMsg = document.createElement("tr");
                            emptyMsg.innerHTML = `<td colspan="10" style="text-align:center;">표시할 배너가 없습니다.</td>`;
                            bannerList.appendChild(emptyMsg);
                            return;
                        }

                        data.forEach((banner, index) => {
                            const tr = document.createElement("tr");


                            tr.innerHTML = `
                            <td><input type="checkbox" value="${banner.banner_no}"></td>
                            <td>${index + 1}</td>
                            <td><img src="/kmarket/uploads/banner/${banner.img}" alt="${banner.banner_name}" style="width:80px;height:80px;"></td>
                            <td style="text-align: left;">
                                <span>${banner.banner_name}</span><br>
                                <span>크기: ${banner.banner_size}</span><br>
                                <span>배경색: ${banner.background_color}</span><br>
                                <a href="${banner.link}" class="banner_a">${banner.link}</a>
                            </td>
                            <td>${banner.location}</td>
                            <td>${banner.start_date}</td>
                            <td>${banner.end_date}</td>
                            <td>${banner.start_time}</td>
                            <td>${banner.end_time}</td>
                            <td>
                                <button class="status_btn" data-status="1" >[활성]</button><br>
                                <button class="status_btn" data-status="0">[비활성]</button>
                            </td>
                        `;
                            const activeBtn = tr.querySelector('button[data-status="1"]');
                            const inactiveBtn = tr.querySelector('button[data-status="0"]');

                            if(banner.banner_status === 1){
                                activeBtn.style.color = "red";
                                inactiveBtn.style.color = "gray";
                            } else {
                                activeBtn.style.color = "gray";
                                inactiveBtn.style.color = "green";
                            }

                            bannerList.appendChild(tr);
                        });
                    })
                    .catch(err => {
                                console.error("배너 불러오기 오류:", err);
                                alert("배너 데이터를 불러오는 중 문제가 발생했습니다.");
                            });
            }

            // 초기 배너 로딩
            const currentLocationInitial = document.querySelector("#banner_box .banner_select.active")?.textContent.trim() || "메인 상단 배너";
            let initialLocation = "";
            switch(currentLocationInitial){
                case "메인 상단 배너": initialLocation = "main1"; break;
                case "메인 슬라이더 배너": initialLocation = "main2"; break;
                case "상품 상세 보기 배너": initialLocation = "product1"; break;
                case "회원 로그인 배너": initialLocation = "member1"; break;
                case "마이페이지 배너": initialLocation = "my"; break;
            }
            loadBanners(initialLocation);

            // 위치 선택 이벤트
            bannerBox.addEventListener("click", (e) => {
                if (e.target.classList.contains("banner_select")) {
                    document.querySelectorAll(".banner_select").forEach(btn => btn.classList.remove("active"));
                    e.target.classList.add("active");

                    let location = "";
                    switch (e.target.textContent.trim()) {
                        case "메인 상단 배너": location = "main1"; break;
                        case "메인 슬라이더 배너": location = "main2"; break;
                        case "상품 상세 보기 배너": location = "product1"; break;
                        case "회원 로그인 배너": location = "member1"; break;
                        case "마이페이지 배너": location = "my"; break;
                    }

                    loadBanners(location);
                }
            });

            /* =====================
               전체 선택 체크박스
            ===================== */
            const allSelect = document.querySelector(".all_select");
            if (allSelect) {
                allSelect.addEventListener("change", () => {
                    const checkboxes = bannerList.querySelectorAll("input[type='checkbox']");
                    checkboxes.forEach(cb => cb.checked = allSelect.checked);
                });
            }

            /* =====================
               모달 제어
            ===================== */
            const modal = document.getElementById("myModal");
            const openBtn = document.querySelector(".banner_regist");
            if(openBtn && modal) {
                const closeBtn = modal.querySelector(".close");
                const form = document.getElementById("bannerForm");

                openBtn.addEventListener("click", () => modal.style.display = "block");
                closeBtn.addEventListener("click", () => modal.style.display = "none");
                window.addEventListener("click", (e) => {
                    if (e.target === modal) modal.style.display = "none";
                });
                modal.querySelector(".modal-content").addEventListener("click", (e) => e.stopPropagation());

                /* =====================
                   배너 등록 (submit)
                ===================== */
                if(form){
                    form.addEventListener("submit", (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        fetch(form.action, { method: 'POST', body: formData })
                            .then(res => {
                                if (res.ok) {
                                    alert("배너 등록 성공!");
                                    location.reload();
                                } else {
                                    alert("등록 실패! 다른 파일을 올려주세요!");
                                }
                            })
                            .catch(err => console.error("배너 등록 오류:", err));
                    });
                }
            }

            /* =====================
               선택 삭제
            ===================== */
            const selectDeleteBtn = document.querySelector(".select_delete");
            if (selectDeleteBtn) {
                selectDeleteBtn.addEventListener("click", () => {
                    const checkedBoxes = bannerList.querySelectorAll("input[type='checkbox']:checked");
                    if (checkedBoxes.length === 0) {
                        alert("삭제할 배너를 선택해주세요.");
                        return;
                    }

                    if (!confirm("선택한 배너를 정말 삭제하시겠습니까?")) return;

                    const bannerNos = Array.from(checkedBoxes).map(cb => cb.value);

                    fetch('/kmarket/admin/config/banner/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bannerNos)
                    })
                        .then(res => {
                            if (res.ok) {
                                alert("배너가 삭제되었습니다.");
                                location.reload();
                            } else {
                                alert("삭제 실패!");
                            }
                        })
                        .catch(err => {
                            console.error("배너 삭제 오류:", err);
                            alert("삭제 중 오류가 발생했습니다.");
                        });
                });
            }

            /* =====================
               상태 버튼 클릭
            ===================== */
            bannerList.addEventListener("click", (e) => {
                if (e.target.classList.contains("status_btn")) {
                    const row = e.target.closest("tr");
                    const banner_no = row.querySelector("input[type='checkbox']").value;
                    const banner_status = parseInt(e.target.dataset.status);

                    fetch('/kmarket/admin/config/banner/status', {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `banner_no=${banner_no}&banner_status=${banner_status}`
                    })
                        .then(res => res.json())
                        .then(data => {
                            if(data.success) {
                                alert("상태가 변경되었습니다.");

                                const activeBtn = row.querySelector('button[data-status="1"]');
                                const inactiveBtn = row.querySelector('button[data-status="0"]');
                                if(banner_status === 1){
                                    activeBtn.style.color = "red";
                                    inactiveBtn.style.color = "gray";
                                } else {
                                    activeBtn.style.color = "gray";
                                    inactiveBtn.style.color = "green";
                                }

                            } else {
                                alert("상태 변경 실패!");
                            }
                        })
                        .catch(err => console.error(err));
                }
            });



        });
    </script>

    <script th:src="@{/js/admin/cs/recruit/sidebarAction.js}" defer></script>
    <link rel="stylesheet" th:href="@{/css/admin/main/sidebar.css}">
</head>
<body>
    <header>
        <div class="header-layout">
            <div class="header-content">
                <a th:href="@{/admin}">
                    <img th:src="@{/images/admin/main/cupangMS_logo(color).png}" alt="로고">
                </a>

                <div class="header-link">
                    <div class="header-item">
                        <a th:href="@{/}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house-icon lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                            <p>HOME</p>
                        </a>
                    </div>

                    <div class="header-item">
                        <a th:href="@{/cs/index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-headset-icon lucide-headset"><path d="M3 11h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm0 0a9 9 0 1 1 18 0m0 0v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3Z"/><path d="M21 16v2a4 4 0 0 1-4 4h-5"/></svg>
                            <p>고객센터</p>
                        </a>
                    </div>

                    <button>로그아웃</button>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="container">
            <aside class="sidebar">
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>
                        <p>환경설정</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/config/basic}" class="sub-link">기본설정</a></li>
                        <li><a th:href="@{/admin/config/banner}" class="sub-link">배너관리</a></li>
                        <li><a th:href="@{/admin/config/policy}" class="sub-link">약관관리</a></li>
                        <li><a th:href="@{/admin/config/category}" class="sub-link">카테고리</a></li>
                        <li><a th:href="@{/admin/config/version}" class="sub-link">버전관리</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store-icon lucide-store"><path d="M15 21v-5a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v5"/><path d="M17.774 10.31a1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.451 0 1.12 1.12 0 0 0-1.548 0 2.5 2.5 0 0 1-3.452 0 1.12 1.12 0 0 0-1.549 0 2.5 2.5 0 0 1-3.77-3.248l2.889-4.184A2 2 0 0 1 7 2h10a2 2 0 0 1 1.653.873l2.895 4.192a2.5 2.5 0 0 1-3.774 3.244"/><path d="M4 10.95V19a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.05"/></svg>
                        <p>상점관리</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/shop/list}" class="sub-link">상점목록</a></li>
                        <li><a th:href="@{/admin/shop/sales}" class="sub-link">매출현황</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-pen-icon lucide-user-pen"><path d="M11.5 15H7a4 4 0 0 0-4 4v2"/><path d="M21.378 16.626a1 1 0 0 0-3.004-3.004l-4.01 4.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z"/><circle cx="10" cy="7" r="4"/></svg>
                        <p>회원관리</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/member/list}" class="sub-link">회원목록</a></li>
                        <li><a th:href="@{/admin/member/point}" class="sub-link">포인트관리</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-open-icon lucide-package-open"><path d="M12 22v-9"/><path d="M15.17 2.21a1.67 1.67 0 0 1 1.63 0L21 4.57a1.93 1.93 0 0 1 0 3.36L8.82 14.79a1.655 1.655 0 0 1-1.64 0L3 12.43a1.93 1.93 0 0 1 0-3.36z"/><path d="M20 13v3.87a2.06 2.06 0 0 1-1.11 1.83l-6 3.08a1.93 1.93 0 0 1-1.78 0l-6-3.08A2.06 2.06 0 0 1 4 16.87V13"/><path d="M21 12.43a1.93 1.93 0 0 0 0-3.36L8.83 2.2a1.64 1.64 0 0 0-1.63 0L3 4.57a1.93 1.93 0 0 0 0 3.36l12.18 6.86a1.636 1.636 0 0 0 1.63 0z"/></svg>
                        <p>상품관리</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/product/list}" class="sub-link">상품목록</a></li>
                        <li><a th:href="@{/admin/product/register}" class="sub-link">상품등록</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text-icon lucide-receipt-text"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M14 8H8"/><path d="M16 12H8"/><path d="M13 16H8"/></svg>
                        <p>주문관리</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/order/list}" class="sub-link">주문현황</a></li>
                        <li><a th:href="@{/admin/order/delivery}" class="sub-link">배송현황</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ticket-percent-icon lucide-ticket-percent"><path d="M2 9a3 3 0 1 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 1 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M9 9h.01"/><path d="m15 9-6 6"/><path d="M15 15h.01"/></svg>
                        <p>쿠폰관리</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/coupon/list}" class="sub-link">쿠폰목록</a></li>
                        <li><a th:href="@{/admin/coupon/issued}" class="sub-link">쿠폰발급현황</a></li>
                    </ul>
                </div>
                <div class="side-item">
                    <div class="main-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-minimal-check-icon lucide-laptop-minimal-check"><path d="M2 20h20"/><path d="m9 10 2 2 4-4"/><rect x="3" y="4" width="18" height="12" rx="2"/></svg>
                        <p>고객센터</p>
                    </div>
                    <ul class="sub-menu">
                        <li><a th:href="@{/admin/cs/notice/list}" class="sub-link">공지사항</a></li>
                        <li><a th:href="@{/admin/cs/faq/list}" class="sub-link">자주묻는질문</a></li>
                        <li><a th:href="@{/admin/cs/qna/list}" class="sub-link">문의하기</a></li>
                        <li><a th:href="@{/admin/cs/recruit/list}" class="sub-link">채용하기</a></li>
                    </ul>
                </div>
            </aside>

            <div class="content">
                <div class="content-header">
                    <h1 class="top-title">배너관리</h1>
                    <div>
                        <span>HOME</span> &nbsp;&gt;&nbsp;
                        <span>환경설정</span> &nbsp;&gt;&nbsp;
                        <span style="font-weight: bold;">배너관리</span> 
                    </div>
                </div>

                <div id="banner_box">
                    <div class="banner_select active">메인 상단 배너</div>
                    <div class="banner_select">메인 슬라이더 배너</div>
                    <div class="banner_select">상품 상세 보기 배너</div>
                    <div class="banner_select">회원 로그인 배너</div>
                    <div class="banner_select">마이페이지 배너</div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <h4>메인 상단배너</h4>
                </div>
                <div class="table-container">
                    <div>
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox" class="all_select"></th>
                                    <th>번호</th>
                                    <th>이미지</th>
                                    <th>배너정보</th>
                                    <th>배너위치</th>
                                    <th>시작일</th>
                                    <th>종료일</th>
                                    <th>시작시간</th>
                                    <th>종료시간</th>
                                    <th>관리</th>
                                </tr>                         
                            </thead>
                            <tbody id="banner_list">

                            </tbody>
                        </table>
                    </div>          
                </div>
                <div>
                    <div class="btn_box">
                        <button class="banner_btn select_delete">선택삭제</button>
                        <button class="banner_btn banner_regist">배너등록</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 모달 박스 -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 style="font-size: 20px;">배너 등록</h3>
                    <span class="close">&times;</span>
                </div>

                <form th:action="@{/admin/config/banner/register}" method="post" id="bannerForm" enctype="multipart/form-data">
                    <div class="form-body">
                        <div class="form_row">
                            <div class="form-label">배너이름</div>
                            <input type="text" name="banner_name" class="form-input" placeholder="배너명입력">
                        </div>
                        <div class="form_row">
                            <div class="form-label">배너크기</div>
                            <input type="text" name="banner_size" class="form-input" placeholder="배너크기입력">
                        </div>
                        <div class="form_row">
                            <div class="form-label">배경색</div>
                            <input type="text" name="background_color" class="form-input" placeholder="배너배경색입력">
                        </div>
                        <div class="form_row">
                            <div class="form-label">배너링크</div>
                            <input type="text" name="link" class="form-input" placeholder="배너링크입력">
                        </div>
                        <div class="form_row">
                            <div class="form-label">배너위치</div>
                            <select id="locationSelect" name="location" class="form-input">
                                <option>선택</option>
                                <option value="main1">MAIN1</option>
                                <option value="main2">MAIN2</option>
                                <option value="product1">PRODUCT1</option>
                                <option value="member1">MEMBER1</option>
                                <option value="my1">MY1</option>
                            </select>
                        </div>
                        <div class="form_row">
                            <div class="form-label">노출날짜</div>
                            <div>
                                <input type="date" name="start_date" class="form-input">&nbsp;~&nbsp;
                                <input type="date" name="end_date" class="form-input">
                            </div>
                        </div>
                        <div class="form_row">
                            <div class="form-label">노출시간</div>
                            <div>
                                <input type="time" name="start_time" class="form-input" style="width:121px;">&nbsp;~&nbsp;
                                <input type="time" name="end_time" class="form-input">
                            </div>
                        </div>
                        <div class="form_row_last">
                            <div class="form-label">배너파일</div>
                            <input type="file" name="imgFile" class="info_file">
                            <span style="font-size:14px;margin-left:10px;">노출 위치에 맞는 크기 권장</span>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <input type="submit" value="등록하기" class="form_btn">
                    </div>
                </form>
            </div>
        </div>
    </main>
    <footer>
        <div class="footer-layout">
            <div class="footer-content">
                <img th:src="@{/images/admin/main/cupangMS_logo(color).png}" alt="로고">
                <div class="about-company">
                    <h2 th:inline="text">[[${basicData.trade_name}]]</h2>
                    <h2 th:inline="text">대표이사 [[${basicData.ceo}]]</h2>
                    <h2>|</h2>
                    <h2>사업자등록번호</h2>
                    <h2 th:inline="text">[[${basicData.business_num}]]</h2>
                    <h2>|</h2>
                    <h2>통신판매업신고</h2>
                    <h2 th:inline="text">[[${basicData.communication_num}]]</h2>
                    <h2>|</h2>
                    <h2 th:inline="text">[[${basicData.addr1}]]</h2>
                    <h2 th:inline="text">[[${basicData.addr2}]]</h2>
                </div>
                <div class="about-company">
                    <h2>고객센터</h2>
                    <h2>|</h2>
                    <h2 th:inline="text">[[${basicData.hp}]]</h2>
                    <h2 th:inline="text">[[${basicData.work_time}]]</h2>

                    <h2>이메일</h2>
                    <h2 th:inline="text">[[${basicData.email}]]</h2>

                    <h2>전자금융거래 분쟁담당</h2>
                    <h2 th:inline="text">[[${basicData.transaction}]]</h2>
                </div>
                <h2 th:inline="text">[[${basicData.copyright}]]</h2>
                <h2 th:inline="text">ver.[[${appInfo.appVersion}]]</h2>
            </div>

        </div>

    </footer>
</body>
</html>