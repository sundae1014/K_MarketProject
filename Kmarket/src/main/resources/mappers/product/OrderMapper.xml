<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kmarket.mapper.OrderMapper">

    <!-- 주문 등록 (유지) -->
    <insert id="insertOrder" parameterType="kr.co.kmarket.dto.OrderDTO">
        <selectKey keyProperty="order_number" resultType="string" order="BEFORE">
            SELECT 'ORD' || LPAD(ORDER_SEQ.NEXTVAL, 8, '0') FROM DUAL
        </selectKey>

        INSERT INTO "ORDER" (
        ORDER_NUMBER, CUST_NUMBER, O_DATE, STAT, NAME, HP, ADDR, ADDR2, PAYMENT
        ) VALUES (
        #{order_number}, #{cust_number}, SYSDATE, 1,
        #{name}, #{hp}, #{addr}, #{addr2}, #{payment}
        )
    </insert>

    <!-- ===================== -->
    <!-- ✅ 신규: 주문 상세 등록 -->
    <!-- ===================== -->
    <insert id="insertOrderDetail" parameterType="kr.co.kmarket.dto.OrderDTO">
        INSERT INTO ORDERDETAIL (
            ORDER_NUMBER, PROD_NUMBER, PRICE, QUANTITY
        ) VALUES (
                     #{order_number}, #{prod_number}, #{salePrice}, #{piece}
                 )
    </insert>

    <!-- ===================== -->
    <!-- ✅ 신규: 주문 단건 조회 -->
    <!-- ===================== -->
    <select id="selectOrderByNumber" parameterType="string" resultType="kr.co.kmarket.dto.OrderDTO">
        SELECT
            ORDER_NUMBER       AS order_number,
            CUST_NUMBER        AS cust_number,
            NAME               AS name,
            HP                 AS hp,
            ADDR               AS addr,
            ADDR2              AS addr2,
            PAYMENT            AS payment,
            O_DATE             AS oDate,
            STAT               AS stat
        FROM "ORDER"
        WHERE ORDER_NUMBER = #{order_number}
    </select>

    <!-- ===================== -->
    <!-- ✅ 신규: 주문 상세 목록 조회 (상품 정보 포함) -->
    <!-- ===================== -->
    <select id="selectOrderDetails" parameterType="string" resultType="kr.co.kmarket.dto.OrderDTO">
        SELECT
            D.ORDER_NUMBER           AS order_number,
            D.PROD_NUMBER            AS prod_number,
            D.PRICE                  AS salePrice,
            D.QUANTITY               AS piece,
            P.PROD_NAME              AS prod_name,
            P.IMG_1                  AS img1,
            P.MANUFACTURE            AS manufacture
        FROM ORDER_DETAIL D
                 JOIN PRODUCT P ON D.PROD_NUMBER = P.PROD_NUMBER
        WHERE D.ORDER_NUMBER = #{order_number}
    </select>

    <!-- 장바구니 목록 (유지) -->
    <select id="selectCartList" resultType="kr.co.kmarket.dto.CartDTO">
        SELECT *
        FROM CART
        WHERE CART_NUMBER IN
        <foreach item="num" collection="cart_numbers" open="(" separator="," close=")">
            #{num}
        </foreach>
    </select>

    <!-- 사용 가능한 쿠폰 (유지) -->
    <select id="selectAvailableCoupons" parameterType="int" resultType="kr.co.kmarket.dto.CouponDTO">
        SELECT
            c.COUPON_NO    AS couponNo,
            c.COUPON_NAME  AS couponName,
            c.BENEFIT      AS benefit,
            c.USE_PERIOD   AS usePeriod,
            c.ISSUE_DATE   AS issueDate,
            c.STATUS       AS status
        FROM COUPON c
        WHERE c.CUST_NUMBER = #{cust_number}
          AND c.STATUS = '미사용'
          AND c.USE_PERIOD >= SYSDATE
        ORDER BY c.ISSUE_DATE DESC
    </select>

    <!-- 회원 포인트 (유지) -->
    <select id="selectUserPoint" parameterType="int" resultType="int">
        SELECT NVL(SUM(POINT_AMOUNT), 0)
        FROM POINT
        WHERE CUST_NUMBER = #{cust_number}
          AND (EXPIRE_DATE IS NULL OR EXPIRE_DATE > SYSDATE)
    </select>

    <!-- 포인트 내역 등록 (유지) -->
    <insert id="insertPoint" parameterType="kr.co.kmarket.dto.PointDTO">
        INSERT INTO POINT (
            POINT_ID, CUST_NUMBER, ORDER_NUMBER, POINT_TYPE,
            POINT_AMOUNT, DESCRIPTION, CREATED_AT
        )
        VALUES (
                   POINT_SEQ.NEXTVAL,
                   #{cust_number},
                   #{order_number},
                   #{point_type},
                   #{point_amount},
                   #{description},
                   SYSDATE
               )
    </insert>

    <!-- 장바구니 번호들로 상세 조회 (유지) -->
    <select id="selectCartItemsByNumbers" resultType="kr.co.kmarket.dto.CartDTO">
        SELECT
        c.CART_NUMBER,
        c.CUST_NUMBER,
        c.PROD_NUMBER,
        c.QUANTITY,
        p.PROD_NAME,
        p.PRICE,
        p.DISCOUNT,
        p.IMG_1,
        o.OPT_NAME,
        o.OPT_PRICE
        FROM CART c
        JOIN PRODUCT p ON c.PROD_NUMBER = p.PROD_NUMBER
        LEFT JOIN PRODUCT_OPTION o ON p.PROD_NUMBER = o.PROD_NUMBER
        WHERE c.CART_NUMBER IN
        <foreach collection="array" item="num" open="(" separator="," close=")">
            #{num}
        </foreach>
    </select>

</mapper>
