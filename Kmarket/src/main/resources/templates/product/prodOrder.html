<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cupang::주문/결제 (5조)</title>
    <link rel="stylesheet" th:href="@{/css/product/style_header.css}">
    <link rel="stylesheet" th:href="@{/css/product/style_footer.css}">
    <link rel="stylesheet" th:href="@{/css/product/style_index.css}">
    <link rel="stylesheet" th:href="@{/css/product/style_prodList.css}">
    <link rel="stylesheet" th:href="@{/css/product/style_prodCart.css}">
    <link rel="stylesheet" th:href="@{/css/product/style_prodOrder.css}">

    <!-- 헤더 상단 공용 검색 기능 -->
    <script th:src="@{/js/product/header-search.js}" defer></script>
    <script th:src="@{/js/product/search.js}" defer></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const CATEGORY_DATA = /*[[${categories}]]*/ {};
        console.log(CATEGORY_DATA);
        /*]]>*/
    </script>
    <script th:src="@{/js/product/category.js}" defer></script>
    <script th:src="@{/js/product/best.js}" defer></script>
    <script th:src="@{/js/product/top-btn.js}" defer></script>
    <script th:src="@{//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js}"></script>
    <script th:src="@{/js/product/postcode.js}"></script>
    <script th:src="@{/js/product/order.js}" id="orderScript" defer></script>
    <script>
        const script = document.getElementById('orderScript');
        script.src += '?v=' + new Date().getTime();
    </script>
</head>
<body>
<main class="page">

    <!-- 헤더 -->
    <div th:replace="~{_header :: headerFragment}"></div>

    <!-- 주문/결제 레이아웃 -->
    <div class="order-wrap">

        <!-- 베스트상품 -->
        <aside class="col-a">
            <div class="best-panel">
                <h3 class="section-title">베스트상품</h3>
                <ol class="best-num-list" id="best-num-list">
                    <li><button data-idx="0">NO.1</button></li>
                    <li><button data-idx="1">NO.2</button></li>
                    <li><button data-idx="2">NO.3</button></li>
                    <li><button data-idx="3">NO.4</button></li>
                    <li><button data-idx="4">NO.5</button></li>
                </ol>
            </div>
        </aside>

        <!-- 우측: 주문/결제 -->
        <section class="col-b">

            <div class="list-header">
                <h2 class="list-title">주문하기</h2>

                <nav class="cart-steps">
                    <ol>
                        <li><a href="#">01 옵션선택</a></li>
                        <li><a th:href="@{/product/cart}">02 장바구니</a></li>
                        <li class="active">03 주문/결제</li>
                        <li><a href="#">04 주문완료</a></li>
                    </ol>
                </nav>
            </div>

            <!-- 주문 내역 -->
            <form th:action="@{/order/complete}" method="post" id="orderForm">
                <div class="order-grid">
                    <!-- 좌측: 주문 상세 -->
                    <div class="order-list">

                        <!-- 구매자 정보 -->
                        <div class="order-section buyer-box">
                            <div class="section-header">
                                <h3>구매자 정보</h3>
                            </div>
                            <div class="buyer-info">
                                <div class="form-row">
                                    <label for="buyerName">이름</label>
                                    <input type="text" id="buyerName" th:value="${buyer.name}" readonly>
                                </div>
                                <div class="form-row">
                                    <label for="buyerPhone">연락처</label>
                                    <input type="text" id="buyerPhone" th:value="${buyer.hp}" readonly>
                                </div>
                                <div class="form-row">
                                    <label for="buyerAddress">주소지</label>
                                    <input type="text" id="buyerAddress" th:value="${buyer.addr1}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- 배송지 정보 -->
                        <div class="order-section delivery-box">
                            <div class="section-header">
                                <h3>배송지 정보</h3>
                            </div>

                            <div class="delivery-info">
                                <div class="form-row">
                                    <label for="name">받는 사람</label>
                                    <input type="text" id="name" placeholder="이름 입력">
                                </div>
                                <div class="form-row">
                                    <label for="hp">연락처</label>
                                    <input type="text" id="hp" placeholder="연락처 입력">
                                </div>
                                <div class="form-row">
                                    <label for="zip">우편번호</label>
                                    <input type="text" id="zip" placeholder="우편번호" readonly>
                                    <button type="button" onclick="execDaumPostcode()">검색</button>
                                </div>
                                <div class="form-row">
                                    <label for="addr">주소</label>
                                    <input type="text" id="addr" placeholder="기본 주소" readonly>
                                </div>
                                <div class="form-row">
                                    <label for="addr2">상세주소</label>
                                    <input type="text" id="addr2" placeholder="상세 주소">
                                </div>
                                <div class="form-row">
                                    <label for="req">배송 메모</label>
                                    <div class="memo-wrap">
                                        <select id="req">
                                            <option value="">배송 메모를 선택해주세요</option>
                                            <option value="부재 시 경비실에 맡겨주세요">부재 시 경비실에 맡겨주세요</option>
                                            <option value="문 앞에 놓아주세요">문 앞에 놓아주세요</option>
                                            <option value="배송 전 연락주세요">배송 전 연락주세요</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 상품 정보 -->
                        <div class="order-section product-box">
                            <div class="section-header">
                                <h3>상품 정보</h3>
                            </div>

                            <th:block th:each="item : ${orderItems}">
                                <div class="product-info"
                                     th:with="unitSale=${ (item.price * (1 - (item.discount / 100.0))) + (item.opt_price != null ? item.opt_price : 0) },
                                              qty=${item.quantity}">
                                    <img th:src="@{${item.img_1}}" alt="상품" class="product-thumb">

                                    <div class="product-detail">
                                        <p class="product-name" th:text="${item.prod_name}"></p>
                                        <p class="product-option"
                                           th:text="${item.quantity + '개, ' + (item.opt_name != null ? item.opt_name : 'free') + ' (' + #numbers.formatInteger(item.opt_price, 3, 'COMMA') + '원)'}"></p>

                                        <div class="product-price">
                                            <span class="discount" th:text="${item.discount + '%'}"></span>
                                            <strong class="sale" th:text="${#numbers.formatInteger(item.opt_price * item.quantity, 3, 'COMMA')}"></strong>원
                                            <del class="regular" th:text="${#numbers.formatInteger(item.price * item.quantity, 3, 'COMMA')} + '원'"></del>
                                        </div>

                                        <div class="product-point">
                                            <p th:text="'최대 ' + ${#numbers.formatInteger(((item.price + (item.opt_price != null ? item.opt_price : 0)) * (1 - (item.discount / 100)) * item.quantity * 0.01), 3, 'COMMA')} + '점 적립'"></p>
                                        </div>
                                    </div>
                                    <input type="hidden" name="prod_number" th:value="${item.prod_number}">
                                    <input type="hidden" name="piece" th:value="${item.quantity}">
                                    <input type="hidden" name="price" th:value="${item.price * item.quantity}">
                                </div>
                            </th:block>

                            <div class="coupon-point-box">
                                <h4>쿠폰/포인트</h4>
                                <div class="coupon-list">
                                    <th:block th:if="${#lists.isEmpty(coupons)}">
                                        <p>사용 가능한 쿠폰이 없습니다.</p>
                                    </th:block>
                                    <th:block th:each="coupon : ${coupons}">
                                        <label>
                                            <input type="checkbox" name="coupon"
                                                   th:data-discount="${coupon.benefit}"
                                                   th:value="${coupon.couponNo}">
                                            <span th:text="${coupon.couponName}"></span>
                                            <span class="coupon-cond" th:text="'(~' + ${coupon.usePeriod} + ')'"></span>
                                        </label>
                                    </th:block>
                                </div>

                                <div class="point-box">
                                    <p>현재 포인트: <strong id="currentPoint" th:text="${#numbers.formatInteger(userPoint,3,'COMMA')}"></strong>점</p>
                                    <input type="number" id="usePoint" placeholder="사용할 포인트 입력">
                                    <button type="button" onclick="applyPoint()">사용하기</button>
                                </div>
                            </div>
                        </div>

                        <!-- 결제방법 -->
                        <div class="order-section payment-box">
                            <div class="section-header">
                                <h3>결제방법</h3>
                            </div>
                            <div class="payment-methods">
                                <button type="button" class="pay-btn active">신용카드</button>
                                <button type="button" class="pay-btn">체크카드</button>
                                <button type="button" class="pay-btn">계좌이체</button>
                                <button type="button" class="pay-btn">무통장입금</button>
                                <button type="button" class="pay-btn">휴대폰결제</button>
                                <button type="button" class="pay-btn">카카오페이</button>
                            </div>
                        </div>
                    </div>

                    <!-- 우측: 최종결제정보 -->
                    <aside class="order-summary">
                        <h3>최종 결제정보</h3>
                        <ul>
                            <li><span>상품수</span><span><strong th:text="${#lists.size(orderItems)}"></strong></span></li>
                            <li><span>상품금액</span><span><strong th:text="${#numbers.formatInteger(basePrice,3,'COMMA')}"></strong>원</span></li>
                            <li><span>할인금액</span><span><strong th:text="${#numbers.formatInteger(couponDiscount,3,'COMMA')}"></strong>원</span></li>
                            <li><span>배송비</span><span><strong th:text="${#numbers.formatInteger(delivery,3,'COMMA')}"></strong>원</span></li>
                            <li><span>적립 포인트</span><span><strong th:text="${#numbers.formatInteger(point,3,'COMMA')}"></strong>점</span></li>
                        </ul>

                        <p class="order-total">
                            <strong th:text="${#numbers.formatInteger(finalPrice,3,'COMMA')}"></strong>원
                        </p>

                        <!-- 서버로 보낼 hidden 값들 -->
                        <input type="hidden" name="cust_number" th:value="${buyer.cust_number}">
                        <input type="hidden" name="price" th:value="${finalPrice}">
                        <input type="hidden" name="usePoint" id="hiddenUsePoint" th:value="${usePoint}">
                        <input type="hidden" name="payment" id="payment" value="신용카드">
                        <input type="hidden" name="delivery" value="0">

                        <!-- ✅ 배송정보 hidden 필드 -->
                        <input type="hidden" name="zip" id="hiddenZip">
                        <input type="hidden" name="req" id="hiddenReq">
                        <input type="hidden" name="name" id="hiddenReceiver">
                        <input type="hidden" name="hp" id="hiddenHp">
                        <input type="hidden" name="addr" id="hiddenAddr1">
                        <input type="hidden" name="addr2" id="hiddenAddr2">

                        <button type="submit" class="btn-order">결제하기</button>
                    </aside>
                </div>
            </form>
        </section>
    </div>

    <button id="topBtn" class="top-btn" aria-label="맨 위로 이동">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m17 11-5-5-5 5"/>
            <path d="m17 18-5-5-5 5"/>
        </svg>
    </button>

    <div th:replace="~{_footer :: footerFragment}"></div>

</main>
</body>
</html>
