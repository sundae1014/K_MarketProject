<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kmarket.mapper.admin.SalesMapper">

    <select id="findAll" resultType="map">
        SELECT
        ROW_NUMBER() OVER (ORDER BY p.MANUFACTURE) AS ID,
        p.MANUFACTURE,
        COUNT(*) AS TOTAL,
        COUNT(CASE WHEN o.STAT = 1 THEN 1 END) AS 결제완료,
        COUNT(CASE WHEN o.STAT = 3 THEN 1 END) AS 배송중,
        COUNT(CASE WHEN o.STAT = 4 THEN 1 END) AS 배송완료,
        COUNT(CASE WHEN o.STAT = 8 THEN 1 END) AS 구매확정,
        SUM(od.PRICE * od.PIECE) AS 주문합계
        FROM ORDERDETAIL od
        JOIN PRODUCT p ON p.PROD_NUMBER = od.PROD_NUMBER
        JOIN "ORDER" o ON od.ORDER_NUMBER = o.ORDER_NUMBER
        WHERE o.STAT IN (1, 3, 4, 8)
        GROUP BY p.MANUFACTURE
        ORDER BY p.MANUFACTURE
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>
    <select id="selectCount" resultType="int">
        SELECT COUNT(DISTINCT p.MANUFACTURE)
        FROM ORDERDETAIL od
        JOIN PRODUCT p ON p.PROD_NUMBER = od.PROD_NUMBER
        JOIN "ORDER" o ON od.ORDER_NUMBER = o.ORDER_NUMBER
        WHERE o.STAT IN (1, 3, 4, 8)
    </select>

    <select id="findTypeAll" resultType="map">
        SELECT
        ROW_NUMBER() OVER (ORDER BY 기준날짜) AS ID,
        manufacture,
        기준날짜,
        COUNT(*) AS TOTAL,
        COUNT(CASE WHEN stat = 1 THEN 1 END) AS 결제완료,
        COUNT(CASE WHEN stat = 3 THEN 1 END) AS 배송중,
        COUNT(CASE WHEN stat = 4 THEN 1 END) AS 배송완료,
        COUNT(CASE WHEN stat = 8 THEN 1 END) AS 구매확정,
        SUM(price * piece) AS 주문합계
        FROM (
        SELECT
        od.PRICE AS price,
        od.PIECE AS piece,
        o.STAT AS stat,
        p.MANUFACTURE AS manufacture,
        <choose>
            <when test="type == 'day'">
                TO_CHAR(o.O_DATE, 'YYYY-MM-DD') AS 기준날짜
            </when>
            <when test="type == 'week'">
                TO_CHAR(TRUNC(o.O_DATE, 'IW'), 'YYYY-MM-DD') AS 기준날짜
            </when>
            <when test="type == 'month'">
                TO_CHAR(o.O_DATE, 'YYYY-MM') AS 기준날짜
            </when>
            <otherwise>
                TO_CHAR(o.O_DATE, 'YYYY-MM-DD') AS 기준날짜
            </otherwise>
        </choose>
        FROM ORDERDETAIL od
        JOIN PRODUCT p ON p.PROD_NUMBER = od.PROD_NUMBER
        JOIN "ORDER" o ON od.ORDER_NUMBER = o.ORDER_NUMBER
        WHERE o.STAT IN (1, 3, 4, 8)
        ) grouped
        GROUP BY manufacture, 기준날짜
        ORDER BY 기준날짜
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <!-- 일/주/월별 총 개수 조회 (페이징용) -->
    <select id="selectCountTotal" resultType="int">
        SELECT COUNT(DISTINCT 기준날짜)
        FROM (
        SELECT
        <choose>
            <when test="type == 'day'">
                TO_CHAR(o.O_DATE, 'YYYY-MM-DD') AS 기준날짜
            </when>
            <when test="type == 'week'">
                TO_CHAR(TRUNC(o.O_DATE, 'IW'), 'YYYY-MM-DD') AS 기준날짜
            </when>
            <when test="type == 'month'">
                TO_CHAR(o.O_DATE, 'YYYY-MM') AS 기준날짜
            </when>
            <otherwise>
                TO_CHAR(o.O_DATE, 'YYYY-MM-DD') AS 기준날짜
            </otherwise>
        </choose>
        FROM ORDERDETAIL od
        JOIN PRODUCT p ON p.PROD_NUMBER = od.PROD_NUMBER
        JOIN "ORDER" o ON od.ORDER_NUMBER = o.ORDER_NUMBER
        WHERE o.STAT IN (1, 3, 4, 8)
        )
    </select>

</mapper>