<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kmarket.mapper.admin.CouponMapper">

    <!-- ✅ 컬럼 ↔ DTO 매핑 -->
    <resultMap id="couponMap" type="kr.co.kmarket.dto.CouponDTO">
        <result column="COUPON_NO" property="couponNo"/>
        <result column="COUPON_TYPE" property="couponType"/>
        <result column="COUPON_NAME" property="couponName"/>
        <result column="BENEFIT" property="benefit"/>
        <result column="USE_PERIOD" property="usePeriod"/>
        <result column="ISSUER" property="issuer"/>
        <result column="ISSUE_DATE" property="issueDate"/>
        <result column="USE_COUNT" property="useCount"/>
        <result column="STATUS" property="status"/>
        <result column="MANAGE" property="manage"/>
        <result column="SAYOUNG" property="sayoung"/>
        <result column="BARGUP" property="bargup"/>
    </resultMap>

    <!-- ✅ 쿠폰 등록 -->
    <insert id="insertCoupon" parameterType="kr.co.kmarket.dto.CouponDTO">
        INSERT INTO COUPON (
            COUPON_NO, COUPON_TYPE, COUPON_NAME, BENEFIT,
            USE_PERIOD, ISSUER, ISSUE_DATE, USE_COUNT,
            STATUS, MANAGE, SAYOUNG, BARGUP
        ) VALUES (
                     COUPON_SEQ.NEXTVAL,
                     #{couponType}, #{couponName}, #{benefit},
                     #{usePeriod}, #{issuer}, #{issueDate}, #{useCount},
                     #{status}, #{manage}, #{sayoung}, #{bargup}
                 )
    </insert>

    <!-- ✅ 페이징 적용된 쿠폰 목록 조회 -->
    <select id="selectCouponsByPage" resultMap="couponMap">
        SELECT * FROM (
                          SELECT ROWNUM AS rnum, c.* FROM (
                                                              SELECT * FROM COUPON ORDER BY COUPON_NO DESC
                                                          ) c
                          WHERE ROWNUM &lt;= #{offset} + #{size}
                      )
        WHERE rnum &gt; #{offset}
    </select>

    <!-- ✅ 전체 쿠폰 개수 조회 -->
    <select id="countCoupons" resultType="int">
        SELECT COUNT(*) FROM COUPON
    </select>

    <!-- ✅ 검색 + 페이지네이션 쿠폰 목록 -->
    <select id="searchCouponsByPage" resultMap="couponMap">
        SELECT * FROM (
        SELECT ROWNUM AS rnum, c.* FROM (
        SELECT * FROM COUPON
        <where>
            <if test="type == 'couponNo'">
                COUPON_NO = #{keyword}
            </if>
            <if test="type == 'couponName'">
                COUPON_NAME LIKE '%' || #{keyword} || '%'
            </if>
            <if test="type == 'issuer'">
                ISSUER LIKE '%' || #{keyword} || '%'
            </if>
        </where>
        ORDER BY COUPON_NO DESC
        ) c
        WHERE ROWNUM &lt;= #{offset} + #{size}
        )
        WHERE rnum &gt; #{offset}
    </select>

    <!-- ✅ 검색된 전체 개수 구하기 -->
    <select id="countSearchCoupons" resultType="int">
        SELECT COUNT(*) FROM COUPON
        <where>
            <if test="type == 'couponNo'">
                COUPON_NO = #{keyword}
            </if>
            <if test="type == 'couponName'">
                COUPON_NAME LIKE '%' || #{keyword} || '%'
            </if>
            <if test="type == 'issuer'">
                ISSUER LIKE '%' || #{keyword} || '%'
            </if>
        </where>
    </select>

    <select id="selectCouponImage" resultType="String">
        SELECT IMAGE_PATH FROM COUPON WHERE CATEGORY_CODE = #{cateCode}
    </select>

</mapper>
