<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kmarket.mapper.admin.CouponMapper">

    <!--  컬럼 ↔ DTO 매핑 -->
    <resultMap id="couponMap" type="kr.co.kmarket.dto.CouponDTO">
        <result column="COUPON_NO" property="couponNo"/>
        <result column="COUPON_TYPE" property="couponType"/>
        <result column="COUPON_TYPENAME" property="couponTypename"/>
        <result column="COUPON_NAME" property="couponName"/>
        <result column="BENEFIT" property="benefit"/>
        <result column="USE_PERIOD" property="usePeriod"/>
        <result column="ISSUER" property="issuer"/>
        <result column="ISSUE_DATE" property="issueDate"/>
        <result column="USE_COUNT" property="useCount"/>
        <result column="STATUS" property="status"/>
        <result column="MANAGE" property="manage"/>
        <result column="SAYOUNG" property="sayoung"/>
        <result column="BARGUP" property="bargup"/>
    </resultMap>

    <!--  쿠폰 등록 -->
    <insert id="insertCoupon" parameterType="kr.co.kmarket.dto.CouponDTO">
        INSERT INTO COUPON (
            COUPON_NO,
            COUPON_TYPE,
            COUPON_NAME,
            BENEFIT,
            USE_PERIOD,
            ISSUER,
            ISSUE_DATE,
            USE_COUNT,
            STATUS,
            MANAGE,
            SAYOUNG,
            BARGUP
        ) VALUES (
                     COUPON_SEQ.NEXTVAL,
                     #{couponType, jdbcType=INTEGER},
                     #{couponName, jdbcType=VARCHAR},
                     #{benefit, jdbcType=VARCHAR},
                     #{usePeriod, jdbcType=VARCHAR},
                     #{issuer, jdbcType=VARCHAR},
                     SYSDATE,
                     0,
                     '정상',
                     #{manage, jdbcType=VARCHAR},
                     0,
                     0
                 )
    </insert>

    <!--  쿠폰 전체 목록 -->
    <select id="selectCoupons" resultMap="couponMap">
        SELECT
            c.coupon_no,
            c.coupon_type,
            CASE c.coupon_type
                WHEN 1 THEN '개별상품 할인'
                WHEN 2 THEN '주문금액 할인'
                WHEN 3 THEN '배송비 무료'
                WHEN 4 THEN '회원등급 전용'
                WHEN 5 THEN '첫구매 전용'
                ELSE '기타'
                END AS coupon_typename,
            c.coupon_name,
            c.benefit,
            c.use_period,
            c.issuer,
            c.issue_date,
            c.use_count,
            c.status,
            c.manage,
            c.sayoung,
            c.bargup
        FROM COUPON c
        ORDER BY c.coupon_no DESC
    </select>

    <!-- 검색 기능 -->
    <select id="selectSearchCoupons" resultMap="couponMap">
        SELECT
        c.coupon_no,
        c.coupon_type,
        CASE c.coupon_type
        WHEN 1 THEN '개별상품 할인'
        WHEN 2 THEN '주문금액 할인'
        WHEN 3 THEN '배송비 무료'
        WHEN 4 THEN '회원등급 전용'
        WHEN 5 THEN '첫구매 전용'
        ELSE '기타'
        END AS coupon_typename,
        c.coupon_name,
        c.benefit,
        c.use_period,
        c.issuer,
        c.issue_date,
        c.use_count,
        c.status,
        c.manage,
        c.sayoung,
        c.bargup
        FROM COUPON c
        <where>
            <choose>
                <when test="type == 'couponNo'">
                    c.coupon_no = #{keyword}
                </when>
                <when test="type == 'couponName'">
                    c.coupon_name LIKE '%' || #{keyword} || '%'
                </when>
                <when test="type == 'issuer'">
                    c.issuer LIKE '%' || #{keyword} || '%'
                </when>
            </choose>
        </where>
        ORDER BY c.coupon_no DESC
    </select>

    <!-- 페이지네이션 -->
    <select id="selectCouponsPage" resultMap="couponMap">
        SELECT * FROM (
        SELECT a.*, ROWNUM AS rn FROM (
        SELECT
        c.coupon_no,
        c.coupon_type,
        CASE c.coupon_type
        WHEN 1 THEN '개별상품 할인'
        WHEN 2 THEN '주문금액 할인'
        WHEN 3 THEN '배송비 무료'
        WHEN 4 THEN '회원등급 전용'
        WHEN 5 THEN '첫구매 전용'
        ELSE '기타'
        END AS coupon_typename,
        c.coupon_name,
        c.benefit,
        c.use_period,
        c.issuer,
        c.issue_date,
        c.use_count,
        c.status,
        c.manage,
        c.sayoung,
        c.bargup
        FROM COUPON c
        <where>
            <if test="type != null and keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'couponName'">
                        c.coupon_name LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'issuer'">
                        c.issuer LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="type == 'couponNo'">
                        c.coupon_no = #{keyword}
                    </when>
                </choose>
            </if>
        </where>
        ORDER BY c.coupon_no DESC
        ) a
        WHERE ROWNUM &lt;= #{offset} + #{size}
        )
        WHERE rn &gt; #{offset}
    </select>

    <select id="countCoupons" resultType="int">
        SELECT COUNT(*) FROM coupon
        <where>
            <if test="type != null and keyword != null and keyword != ''">
                <choose>
                    <when test="type == 'couponName'">
                        coupon_name LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="type == 'issuer'">
                        issuer LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="type == 'couponNo'">
                        coupon_no = #{keyword}
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <select id="selectCouponImage" resultType="String">
        SELECT IMAGE_PATH FROM COUPON WHERE CATEGORY_CODE = #{cateCode}
    </select>
</mapper>
