<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.kmarket.mapper.admin.AdminPointMapper">
    <sql id="searchWhere">
        <trim prefix="" prefixOverrides="AND |OR ">
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'id'">
                        AND m.CUSTID LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'name'">
                        AND m.NAME LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'email'">
                        AND m.EMAIL LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'hp'">
                        AND m.hp LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </trim>
    </sql>

    <select id="findById" resultType="kr.co.kmarket.dto.PointDTO">
        SELECT * FROM POINT
        WHERE POINT_ID = #{point_id}
    </select>

    <select id="findAll" resultType="map">
        SELECT p.POINT_ID,
        m.CUSTID,
        m.NAME,
        p.POINT_AMOUNT,
        p.BALANCE,
        p.DESCRIPTION,
        p.CREATED_AT
        FROM MEMBER m
        JOIN POINT p ON m.CUST_NUMBER=p.CUST_NUMBER
        WHERE p.POINT_AMOUNT != 0
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>
    <select id="selectCount" resultType="int">
        SELECT COUNT(m.CUSTID)
        FROM MEMBER m
        JOIN POINT p ON m.CUST_NUMBER=p.CUST_NUMBER
        WHERE p.POINT_AMOUNT != 0
    </select>

    <select id="searchAll" resultType="map">
        SELECT ROW_NUMBER() OVER (ORDER BY m.CUST_NUMBER) AS ID,
        m.CUSTID,
        m.NAME,
        p.POINT_AMOUNT,
        p.BALANCE,
        p.DESCRIPTION,
        p.CREATED_AT
        FROM MEMBER m
        JOIN POINT p ON m.CUST_NUMBER=p.CUST_NUMBER
        <where>
            AUTH = 1
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                AND <include refid="searchWhere"/>
            </if>
        </where>
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>
    <select id="searchCountTotal" resultType="int">
        SELECT COUNT(DISTINCT m.CUSTID)
        FROM MEMBER m
        JOIN POINT p ON m.CUST_NUMBER=p.CUST_NUMBER
        <where>
            AUTH = 1
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                AND <include refid="searchWhere"/>
            </if>
        </where>
    </select>

    <update id="updatePoint">
        UPDATE POINT
        SET BALANCE = #{balance}
        WHERE CUST_NUMBER = #{cust_number}
    </update>

    <delete id="delete">
        DELETE FROM POINT
        WHERE POINT_ID = #{point_id}
    </delete>
</mapper>